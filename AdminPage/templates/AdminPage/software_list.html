{% extends 'base_admin.html' %}
{% load static %}

{% block title %}Manage Software - Admin Panel{% endblock %}

{% block extra_css %}
<style>
    .software-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    
    .software-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    
    .filter-bar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    
    .modal-content {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    
    .action-button {
        transition: all 0.2s ease;
    }
    
    .action-button:hover {
        transform: scale(1.1);
    }
</style>
{% endblock %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
{% csrf_token %}

<div class="space-y-6" x-data="softwareManager()">
    <!-- Delete Confirmation Modal -->
    <div x-show="showDeleteModal" class="modal-overlay" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
        <div class="modal-content" x-transition:enter="transition ease-out duration-300 transform" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Delete Software</h3>
                <p class="text-sm text-gray-500 mb-6">
                    Are you sure you want to delete "<span x-text="selectedSoftware.title"></span>"? This action cannot be undone.
                </p>
                <div class="flex justify-center space-x-4">
                    <button @click="showDeleteModal = false" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg transition-colors duration-200">
                        Cancel
                    </button>
                    <button @click="confirmDelete()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Page Header -->
    <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 flex items-center">
                    <i class="fas fa-cogs text-blue-500 mr-3"></i>
                    Manage Software
                </h1>
                <p class="text-gray-600 mt-1">View and manage all uploaded software</p>
            </div>
            <div class="flex space-x-3">
                <a href="{% url 'adminpage:software_upload' %}" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center">
                    <i class="fas fa-plus mr-2"></i>
                    Upload New
                </a>
                <a href="{% url 'adminpage:admin_home' %}" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center">
                    <i class="fas fa-home mr-2"></i>
                    Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="filter-bar text-white p-6 rounded-lg shadow-lg">
        <form method="get" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Search -->
                <div>
                    <label class="block text-sm font-medium mb-2">Search</label>
                    <input type="text" name="search" value="{{ search_query }}" placeholder="Search software..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- Status Filter -->
                <div>
                    <label class="block text-sm font-medium mb-2">Status</label>
                    <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Status</option>
                        <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                        <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
                    </select>
                </div>
                
                <!-- Category Filter -->
                <div>
                    <label class="block text-sm font-medium mb-2">Category</label>
                    <select name="category" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}" {% if category_filter == category.id|stringformat:"s" %}selected{% endif %}>
                                {{ category.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Filter Button -->
                <div class="flex items-end">
                    <button type="submit" class="w-full bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors duration-200 flex items-center justify-center">
                        <i class="fas fa-filter mr-2"></i>
                        Filter
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Results Summary -->
    <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-4">
        <div class="flex items-center justify-between">
            <p class="text-gray-600">
                Showing <span class="font-semibold">{{ total_software }}</span> software items
            </p>
            <div class="flex items-center space-x-2">
                <span class="text-sm text-gray-500">View:</span>
                <button @click="setViewMode('grid')" :class="viewMode === 'grid' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'" class="px-3 py-1 rounded text-sm">
                    <i class="fas fa-th-large"></i>
                </button>
                <button @click="setViewMode('list')" :class="viewMode === 'list' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'" class="px-3 py-1 rounded text-sm">
                    <i class="fas fa-list"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Software Grid/List -->
    <div x-show="viewMode === 'grid'" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for software in software_list %}
        <div class="software-card bg-white shadow-lg rounded-lg border border-gray-200 overflow-hidden">
            <div class="relative">
                {% if software.thumbnail %}
                    <img src="{{ software.thumbnail.url }}" alt="{{ software.title }}" class="w-full h-48 object-cover">
                {% else %}
                    <div class="w-full h-48 bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center">
                        <i class="fas fa-file-alt text-white text-4xl"></i>
                    </div>
                {% endif %}
                <div class="absolute top-2 right-2">
                    {% if software.is_active %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            Active
                        </span>
                    {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                            Inactive
                        </span>
                    {% endif %}
                </div>
            </div>
            <div class="p-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-2">{{ software.title }}</h3>
                <p class="text-sm text-gray-600 mb-3 line-clamp-2">{{ software.description|truncatewords:15 }}</p>
                <div class="flex items-center justify-between text-sm text-gray-500 mb-3">
                    <span>v{{ software.version }}</span>
                    <span>{{ software.download_count }} downloads</span>
                </div>
                <div class="flex items-center justify-between text-sm text-gray-500 mb-4">
                    <span>{{ software.category.name|default:"No Category" }}</span>
                    <span>{{ software.created_at|date:"M d, Y" }}</span>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="h-6 w-6 bg-gray-300 rounded-full flex items-center justify-center mr-2">
                            <span class="text-xs font-bold text-gray-600">{{ software.uploader.username|first|upper }}</span>
                        </div>
                        <span class="text-sm text-gray-600">{{ software.uploader.username }}</span>
                    </div>
                    <div class="flex space-x-2">
                        <button @click="toggleStatus({{ software.id }})" 
                                class="action-button text-green-600 hover:text-green-800 text-sm" 
                                title="Toggle Status">
                            <i class="fas fa-toggle-{% if software.is_active %}on{% else %}off{% endif %}"></i>
                        </button>
                        <a href="{% url 'adminpage:software_edit' software.id %}" 
                           class="action-button text-blue-600 hover:text-blue-800 text-sm" 
                           title="Edit">
                            <i class="fas fa-edit"></i>
                        </a>
                        <button @click="showDeleteConfirmation({{ software.id }}, '{{ software.title|escapejs }}')" 
                                class="action-button text-red-600 hover:text-red-800 text-sm" 
                                title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-span-full text-center py-12">
            <i class="fas fa-inbox text-gray-400 text-6xl mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No software found</h3>
            <p class="text-gray-500 mb-4">No software matches your current filters.</p>
            <a href="{% url 'adminpage:software_upload' %}" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors duration-200 inline-flex items-center">
                <i class="fas fa-plus mr-2"></i>
                Upload First Software
            </a>
        </div>
        {% endfor %}
    </div>

    <!-- List View -->
    <div x-show="viewMode === 'list'" class="bg-white shadow-lg rounded-lg border border-gray-200 overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Software</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Uploader</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Downloads</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for software in software_list %}
                <tr class="hover:bg-gray-50 transition-colors duration-150">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                {% if software.thumbnail %}
                                    <img src="{{ software.thumbnail.url }}" alt="{{ software.title }}" class="h-10 w-10 rounded object-cover">
                                {% else %}
                                    <div class="h-10 w-10 bg-gray-300 rounded flex items-center justify-center">
                                        <i class="fas fa-file-alt text-gray-600"></i>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">{{ software.title }}</div>
                                <div class="text-sm text-gray-500">v{{ software.version }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ software.category.name|default:"No Category" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ software.uploader.username }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ software.download_count }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if software.is_active %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                Active
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                Inactive
                            </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ software.created_at|date:"M d, Y" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-2">
                            <button @click="toggleStatus({{ software.id }})" 
                                    class="action-button text-green-600 hover:text-green-900" 
                                    title="Toggle Status">
                                <i class="fas fa-toggle-{% if software.is_active %}on{% else %}off{% endif %}"></i>
                            </button>
                            <a href="{% url 'adminpage:software_edit' software.id %}" 
                               class="action-button text-blue-600 hover:text-blue-900" 
                               title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button @click="showDeleteConfirmation({{ software.id }}, '{{ software.title|escapejs }}')" 
                                    class="action-button text-red-600 hover:text-red-900" 
                                    title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="px-6 py-12 text-center">
                        <i class="fas fa-inbox text-gray-400 text-4xl mb-4"></i>
                        <p class="text-gray-500">No software found matching your criteria.</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function softwareManager() {
    return {
        viewMode: 'grid',
        showDeleteModal: false,
        selectedSoftware: {
            id: null,
            title: ''
        },
        
        init() {
            // Initialize view mode from localStorage
            this.viewMode = localStorage.getItem('softwareViewMode') || 'grid';
        },
        
        setViewMode(mode) {
            this.viewMode = mode;
            localStorage.setItem('softwareViewMode', mode);
        },
        
        showDeleteConfirmation(softwareId, softwareTitle) {
            this.selectedSoftware = {
                id: softwareId,
                title: softwareTitle
            };
            this.showDeleteModal = true;
        },
        
        async confirmDelete() {
            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const response = await fetch(`{% url 'adminpage:software_delete' 0 %}`.replace('0', this.selectedSoftware.id), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json',
                    },
                });
                
                if (response.ok) {
                    this.showNotification('Software deleted successfully!', 'success');
                    // Reload the page to reflect changes
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    this.showNotification('Error deleting software. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                this.showNotification('Error deleting software. Please try again.', 'error');
            }
            
            this.showDeleteModal = false;
        },
        
        async toggleStatus(softwareId) {
            try {
                // Since the view is @csrf_exempt, we don't need CSRF token
                const response = await fetch(`{% url 'adminpage:software_toggle' 0 %}`.replace('0', softwareId), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.showNotification(data.message, 'success');
                    // Reload the page to reflect changes
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    this.showNotification(data.message || 'Error updating software status.', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                this.showNotification('Error updating software status. Please try again.', 'error');
            }
        },
        
        showNotification(message, type) {
            // Create a simple notification
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 ${
                type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
            }`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
                notification.style.opacity = '1';
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }
    }
}
</script>
{% endblock %}